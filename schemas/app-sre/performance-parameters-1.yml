---
"$schema": /metaschema-1.json
version: '1.0'

type: object
additionalProperties: false

properties:
  "$schema":
    type: string
    enum:
    - /app-sre/performance-parameters-1.yml

  labels:
    "$ref": "/common-1.json#/definitions/labels"

  name:
    "$ref": "/common-1.json#/definitions/identifier"

  app:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/app-sre/app-1.yml"

  component:
    description: "generates prometheusRuleName: <component>-slos-<ns>"
    "$ref": "/common-1.json#/definitions/identifier"

  prometheusLabels:
    description: "labels that Prometheus uses to select this rules file"
    type: object

  namespace:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/openshift/namespace-1.yml"

  reports:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        date:
          type: string
          pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"

        url:
          type: string
          format: uri
          description: "Link this to some proof of where SLI's values are coming from. Not a JIRA ticket"

      required:
      - date
      - url

  SLIRecordingRules:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        name:
          type: string
          description: "Name describing this property. Must be unique"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        kind:
          type: string
          enum: ['http_rate', 'latency_rate']

        metric:
          type: string
          description: "Metric used for this rule"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        selectors:
          description: "Metric selectors to be used in Prometheus rule"
          type: array
          items:
            "$ref": "/common-1.json#/definitions/promSelector"

        percentile:
          description: "Percentile for latency_rate metrics"

        httpStatusLabel:
          description: "Name of the label that contains the http status code"
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

      required:
      - name
      - kind
      - metric
      - selectors

  volume:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        name:
          type: string
          description: "Name describing this property. Must be unique"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        kind:
          type: string
          enum: ['SLO']

        rules:
          type: string
          description: "Name of the sli recording rules we will be using here. It must exist"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        target:
          description: "SLO target percentage"
          type: number

        additionalLabels:
          description: "Additional labels to tag the recording rules"
          type: array
          items:
            "$ref": "/common-1.json#/definitions/promSelector"

      required:
      - name
      - kind
      - rules
      - target

  availability:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        name:
          type: string
          description: "Name describing this property. Must be unique"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        kind:
          type: string
          enum: ['SLO']

        rules:
          type: object
          additionalProperties: false
          description: "Set of latency/errors slo rule names."
          properties:
            latency:
              type: array
              items:
                type: string
                pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"
            errors:
              type: array
              items:
                type: string
                pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"
          required:
          - latency
          - errors

        target:
          description: "SLO target percentage"
          type: number

        additionalLabels:
          description: "Additional labels to tag the recording rules"
          type: array
          items:
            "$ref": "/common-1.json#/definitions/promSelector"

      required:
      - name
      - kind
      - rules
      - target

  latency:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        name:
          type: string
          description: "Name describing this property. Must be unique"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        kind:
          type: string
          enum: ['SLO']

        rules:
          type: string
          description: "Name of the sli recording rules we will be using here. It must exist"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        threshold:
          description: "threshold in seconds"
          type: number

        target:
          description: "SLO target percentage"
          type: number

        additionalLabels:
          description: "Additional labels to tag the recording rules"
          type: array
          items:
            "$ref": "/common-1.json#/definitions/promSelector"

      required:
      - name
      - kind
      - rules
      - threshold
      - target

  errors:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        name:
          type: string
          description: "Name describing this property. Must be unique"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        kind:
          type: string
          enum: ['SLO']

        rules:
          type: string
          description: "Name of the sli recording rules we will be using here. It must exist"
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        target:
          description: "SLO target percentage"
          type: number

        additionalLabels:
          description: "Additional labels to tag the recording rules"
          type: array
          items:
            "$ref": "/common-1.json#/definitions/promSelector"

      required:
      - name
      - kind
      - rules
      - target

  rawRecordingRules:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        record:
          type: string

        expr:
          type: string

        labels:
          type: object

    required:
    - record
    - expr
    - labels

  rawAlerting:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        alert:
          type: string

        expr:
          type: string

        for:
          type: string

        labels:
          type: object

        annotations:
          type: object
          additionalProperties: false

          properties:
            message:
              type: string

            runbook:
              type: string
              pattern: "^https?://"

            dashboard:
              type: string
              pattern: "^https?://"

            link_url:
              type: string
              pattern: "https?://"

          required:
          - message
          - runbook
          - dashboard

      required:
      - alert
      - expr
      - for
      - labels

required:
- labels
- name
- app
- component
- prometheusLabels
- namespace
- SLIRecordingRules
- volume
- availability
- latency
- errors
